<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Bus Ticketing Service</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        h1 {
            text-align: center;
        }

        .route {
            border: 1px solid #ccc;
            margin-bottom: 20px;
            padding: 10px;
        }

        .stops {
            display: flex;
            flex-wrap: wrap;
        }

        .stop {
            border: 1px solid #ccc;
            padding: 10px;
            margin-right: 10px;
            margin-bottom: 10px;
            width: 200px;
            cursor: pointer; /* Change cursor to pointer on hover */
        }

        .stop h3 {
            margin-top: 0;
        }

        .stop p {
            margin: 5px 0;
        }

        .selected-stop-red {
            background-color: red; /* Change background color of first selected stop to red */
        }

        .selected-stop-green {
            background-color: lightgreen; /* Change background color of second selected stop to green */
        }

        #reserveBtn {
            display: block;
            margin: 20px auto;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="text/javascript">

        $(document).ready(function () {
            var firstClickedStop = null; // Store the first clicked stop
            var secondClickedStop = null; // Store the second clicked stop

            // Fetch city options and populate select elements
            $.get("/stops", function (data) {
                populateSelectOptions(data);
            }).fail(function (xhr, status, error) {
                console.error("Error fetching cities:", error);
            });

            // Function to populate select elements with city options
            function populateSelectOptions(cities) {
                var $departureSelect = $('#departureCity');
                var $arrivalSelect = $('#arrivalCity');

                $departureSelect.append($('<option>', {
                    value: '',
                    text: ''
                }));
                $arrivalSelect.append($('<option>', {
                    value: '',
                    text: ''
                }));

                cities.forEach(function (city) {
                    $departureSelect.append($('<option>', {
                        value: city.cityName,
                        text: city.cityName
                    }));
                    $arrivalSelect.append($('<option>', {
                        value: city.cityName,
                        text: city.cityName
                    }));
                });
            }

            $('#searchResults').on('click', '.stop', function () {
                var stopId = $(this).data('stop-id');

                // If both stops are already selected, unselect the clicked stop
                if (firstClickedStop !== null && secondClickedStop !== null) {
                    $(this).removeClass('selected-stop-red selected-stop-green');
                    if (firstClickedStop === stopId) {
                        firstClickedStop = null;
                    } else if (secondClickedStop === stopId) {
                        secondClickedStop = null;
                    }
                    return;
                }

                // Toggle selection
                if ($(this).hasClass('selected-stop-red') || $(this).hasClass('selected-stop-green')) {
                    $(this).removeClass('selected-stop-red selected-stop-green');
                    if (firstClickedStop === stopId) {
                        firstClickedStop = null;
                    } else if (secondClickedStop === stopId) {
                        secondClickedStop = null;
                    }
                } else {
                    if (firstClickedStop === null) {
                        $(this).addClass('selected-stop-red');
                        firstClickedStop = stopId;
                    } else if (secondClickedStop === null) {
                        $(this).addClass('selected-stop-green');
                        secondClickedStop = stopId;
                    }
                }
            });


            // Log selected departure city
            $('#departureCity').on('change', function () {
                //console.log('Arrival city selected:', $(this).val());
                updateRoutes();
            });

            // Log selected arrival city
            $('#arrivalCity').on('change', function () {
                //console.log('Arrival city selected:', $(this).val());
                updateRoutes();
            });

            // Function to update routes based on selected cities
            function updateRoutes() {
                //console.log('Updating routes...');
                var departureCityName = $('#departureCity').val();
                //console.log('Departure city ID:', departureCityId);
                var arrivalCityName = $('#arrivalCity').val();
                //console.log('Arrival city ID:', arrivalCityId);

                // Make AJAX request to fetch routes based on selected cities
                $.get("/routes/search/" + departureCityName  + "/" + arrivalCityName, function (data) {
                    //console.log(data)
                    renderRoutes(data);
                }).fail(function (xhr, status, error) {
                    console.error("Error fetching routes:", error);
                });
            }

            // Fetch and render routes initially
            updateRoutes();

            // Function to handle reservation
            $('#reserveBtn').on('click', function () {
                if (firstClickedStop !== null && secondClickedStop !== null) {
                    // Redirect to reservation page with selected stop IDs as query parameters
                    window.location.href = '/book?stopId1=' + firstClickedStop + '&stopId2=' + secondClickedStop;
                } else {
                    alert('Please select two stops.');
                }
            });
        });

        function renderRoutes(routes) {
            var $searchResults = $('#searchResults');
            $searchResults.empty(); // Clear existing content

            if (routes.length === 0) {
                $searchResults.html('<p>No routes available for the selected cities.</p>');
            } else {
                routes.forEach(function (route) {
                    var routeHtml = '<div class="route">';
                    routeHtml += '<h2>Route ID: ' + route.id + '</h2>';
                    routeHtml += '<div class="stops">';
                    route.stops.forEach(function (stop) {
                        routeHtml += '<div class="stop" data-stop-id="' + stop.id + '">';
                        routeHtml += '<h3>' + stop.cityName + '</h3>';
                        routeHtml += '<p>Arrival Time: ' + stop.arrivalTime + '</p>';
                        routeHtml += '<p>Departure Time: ' + stop.departureTime + '</p>';
                        routeHtml += '</div>'; // Close .stop
                    });
                    routeHtml += '</div>'; // Close .stops
                    routeHtml += '</div>'; // Close .route
                    $searchResults.append(routeHtml);
                });
            }
        }
    </script>
</head>
<body>
<h1>Search for Bus Tickets</h1>

<!-- Select elements for city options -->
<div>
    <label for="departureCity">Departure City:</label>
    <select id="departureCity">
        <!-- Options will be dynamically populated -->
    </select>
</div>
<div>
    <label for="arrivalCity">Arrival City:</label>
    <select id="arrivalCity">
        <!-- Options will be dynamically populated -->
    </select>
</div>

<div id="searchResults">
    <!-- Routes will be dynamically populated here -->
</div>

<!-- Reservation button -->
<button id="reserveBtn">Reserve</button>

</body>
</html>
